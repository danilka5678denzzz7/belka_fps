<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–µ–ª–∏—á–∏–π –õ–∞–≥–æ–º–µ—Ç—Ä (Squirrel Wars)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --bg-color: #79c753;
            --text-color: #fff;
            --info-bg: rgba(0, 0, 0, 0.7);
            --modal-bg: #fff;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        /* --- TWA –ê–î–ê–ü–¢–ê–¶–ò–Ø --- */
        html, body {
            height: 100vh; 
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }
        
        body {
            font-family: Arial, sans-serif;
            color: var(--text-color);
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            background: var(--tg-theme-bg-color, var(--bg-color)); 
        }

        #game-area {
            position: relative;
            width: 100%;
            cursor: pointer;
            
            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è TWA, —á—Ç–æ–±—ã –∑–∞–Ω–∏–º–∞—Ç—å 100% */
            top: 0; 
            height: 100%; 
            
            background-color: #ffffff; 
            
            max-width: 500px; 
            margin: 0 auto;
            
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* –ù–û–í–´–ô –≠–õ–ï–ú–ï–ù–¢: –ù–µ–ø—Ä–æ–Ω–∏—Ü–∞–µ–º—ã–π –≤–µ—Ä—Ö–Ω–∏–π –±–∞—Ä */
        #top-bar-overlay {
            position: fixed; 
            top: 0;
            max-width: 500px;
            width: 100%; 
            height: 60px; 
            background-color: white; 
            z-index: 200; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            left: 50%;
            transform: translateX(-50%);
            display: none; /* –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –°–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª touch-—Å–æ–±—ã—Ç–∏—è–º */
        }
        
        /* –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –°–ß–ï–¢–ß–ò–ö–û–í */
        #info-container {
            position: fixed;
            top: 0;
            width: 100%;
            max-width: 500px;
            height: 60px; 
            z-index: 210;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box; 
            pointer-events: none; /* –ò–ó–ú–ï–ù–ï–ù–ò–ï 3: –ü–æ–∑–≤–æ–ª—è–µ—Ç –∫–ª–∏–∫–∞–º –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Å–∫–≤–æ–∑—å –±–∞—Ä */
        }


        /* --- –°–¢–ò–õ–ò –≠–õ–ï–ú–ï–ù–¢–û–í –ò–ì–†–´ --- */

        .info-box {
            position: relative; 
            padding: 5px 10px; 
            background-color: var(--info-bg); 
            color: var(--text-color); 
            font-size: 1.2em; 
            border-radius: 5px;
            z-index: 210; 
            pointer-events: auto; /* –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Å–∞–º–æ–≥–æ box, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è */
        }

        .squirrel {
            position: absolute;
            width: 30px; 
            height: 30px; 
            pointer-events: none;
            user-select: none;

            z-index: 50; 
            background-image: url('images/your-squirrel.png'); 
            background-size: contain; 
            background-repeat: no-repeat;
            background-position: center;
            outline: none; 
        }

        #click-tip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(0, 0, 0, 0.5); 
            font-size: 1.5em;
            z-index: 5;
            text-align: center;
        }

        /* --- –°–¢–ò–õ–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê --- */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300; 
        }

        #modal-content {
            background-color: var(--modal-bg);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            color: #333;
            animation: fadeIn 0.5s;
            max-width: 90%;
        }

        #final-score-container {
            font-size: 1.2em;
            margin: 10px 0;
        }
        
        #final-score {
            font-size: 4em;
            font-weight: bold;
            color: #ff6600;
        }

        #final-fps {
            font-size: 1.5em;
            color: #cc0000;
            font-weight: bold;
            margin-top: 10px;
        }
        
        #share-button {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            background-color: #0088cc; 
            color: white;
            border: none;
            border-radius: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

    <div id="game-area">
        <p id="click-tip">–ù–∞–∂–º–∏—Ç–µ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ, —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å –±–µ–ª–æ–∫!</p>
    </div>
    
    <div id="top-bar-overlay"></div> 
    
    <div id="info-container">
        <div id="fps-display" class="info-box">
            FPS: <span id="fps-value">--</span>
        </div>
        <div id="score-display" class="info-box">
            –ë–ï–õ–û–ö: <span id="score-value">0</span>
        </div>
    </div>


    <div id="modal-overlay">
        <div id="modal-content">
            <h2>üèÜ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù!</h2>
            <p>–í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–¥–µ—Ä–∂–∞–ª–æ</p>
            <p id="final-score-container">
                <span id="final-score">0</span> –ë–ï–õ–û–ö!
            </p>
            <p id="final-fps">–ú–∏–Ω. FPS: --</p>
            <button id="share-button" onclick="shareResult()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º</button>
            <button onclick="resetGame()">–ù–∞—á–∞—Ç—å –°–Ω–æ–≤–∞</button>
        </div>
    </div>

    <script>
        // --- 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEB APP (TWA) ---
        const isTelegram = window.Telegram && window.Telegram.WebApp;
        const tg = isTelegram ? window.Telegram.WebApp : null;
        const STORAGE_KEY = 'squirrel_wars_high_score'; 

        if (isTelegram) {
            tg.ready();
            tg.expand(); 
            document.body.style.backgroundColor = tg.themeParams.bg_color || '#79c753';
        }
        
        // --- 2. –§–£–ù–ö–¶–ò–ò CLOUD STORAGE (–ó–∞–≥–ª—É—à–∫–∏) ---

        function saveProgress(finalScore) {
            if (isTelegram && tg.CloudStorage) {
                tg.CloudStorage.setItem(STORAGE_KEY, String(finalScore), (error, was_saved) => {
                    if (error) {
                        console.error("Cloud Storage Save Error:", error);
                    }
                });
            }
        }

        if (isTelegram) {
            window.addEventListener('pagehide', () => { if (score > 0) saveProgress(score); });
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden' && score > 0) saveProgress(score);
            });
        }
        
        // --- 3. –û–°–ù–û–í–ù–û–ô –ö–û–î –ò–ì–†–´ ---
        
        const gameArea = document.getElementById('game-area');
        const scoreValue = document.getElementById('score-value');
        const fpsValue = document.getElementById('fps-value');
        const modalOverlay = document.getElementById('modal-overlay');
        const finalScore = document.getElementById('final-score');
        const finalFpsDisplay = document.getElementById('final-fps');
        const clickTip = document.getElementById('click-tip');

        let score = 0;
        let lastTime = 0;
        let animationFrameId; 
        let squirrels = []; 

        const SQUIRREL_SIZE = 30; 
        const MAX_FPS_CAP = 60; 
        const LAG_THRESHOLD_FPS = 10; 
        const INITIAL_SQUIRREL_SPEED = 1.0; 
        const BUFFER_SIZE = 30; 
        
        // --- –õ–û–ì–ò–ö–ê –°–ß–ï–¢–ê (–£–ü–†–û–©–ï–ù–ê –î–û 1:1) ---
        const SCORE_INCREMENT = 1; // 1 –±–µ–ª–∫–∞ = 1 –æ—á–∫–æ
        
        let smoothedFps = 60; 
        const FPS_SMOOTHING_FACTOR = 0.01; 

        let minAchievedFps = MAX_FPS_CAP; 

        let isHolding = false;
        let spawnIntervalId = null;
        
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï 4: –£–°–ö–û–†–ï–ù–ò–ï –°–ü–ê–í–ù–ê
        // –°–ø–∞–≤–Ω –±—ã—Å—Ç—Ä–µ–µ: 100 –º—Å (10 —Ä–∞–∑ –≤ —Å–µ–∫) –∏ 2 –±–µ–ª–∫–∏ –∑–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª = 20 –±–µ–ª–æ–∫/—Å–µ–∫
        const SPAWN_RATE_MS = 100; 
        const SQUIRRELS_PER_INTERVAL = 2; 
        
        
        function spawnSingleSquirrel() {
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç –Ω–∞ 1
            score += SCORE_INCREMENT;
            scoreValue.textContent = score;

            const squirrelElement = document.createElement('div');
            squirrelElement.className = 'squirrel';

            const gameRect = gameArea.getBoundingClientRect();
            const width = gameRect.width;
            const height = gameRect.height;
            
            // –¢–æ—á–∫–∞ —Å–ø–∞–≤–Ω–∞: –°–ª—É—á–∞–π–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –∏–≥—Ä–æ–≤–æ–º –ø–æ–ª–µ
            const startX = Math.random() * (width - SQUIRREL_SIZE);
            const startY = Math.random() * (height - SQUIRREL_SIZE); 
            
            // –í–µ–∫—Ç–æ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏: –°–ª—É—á–∞–π–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            const angle = Math.random() * 2 * Math.PI; 
            const speed = INITIAL_SQUIRREL_SPEED + (Math.random() * 0.5); 

            const vx = Math.cos(angle) * speed; 
            const vy = Math.sin(angle) * speed; 

            squirrelElement.style.left = `${startX}px`;
            squirrelElement.style.top = `${startY}px`;

            const squirrelData = {
                element: squirrelElement,
                x: startX, 
                y: startY,
                vx: vx, 
                vy: vy,
            };

            squirrels.push(squirrelData);
            gameArea.appendChild(squirrelElement);
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–ø—É—Å–∫ –ø–∞–∫–µ—Ç–∞ –±–µ–ª–æ–∫ (2 –±–µ–ª–∫–∏ –∑–∞ —Ä–∞–∑)
        function startSpawner() {
            for (let i = 0; i < SQUIRRELS_PER_INTERVAL; i++) {
                spawnSingleSquirrel();
            }
        }

        function startSpawning(e) {
            if (isHolding || modalOverlay.style.display === 'flex') return; 
            if (e.type === 'touchstart' || e.type === 'mousedown') e.preventDefault();
            
            isHolding = true;
            clickTip.style.display = 'none'; 
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π –ø–∞–∫–µ—Ç —Å—Ä–∞–∑—É
            startSpawner();

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø–∞–∫–µ—Ç–∞
            spawnIntervalId = setInterval(startSpawner, SPAWN_RATE_MS); 
        }

        function stopSpawning() {
            if (spawnIntervalId) {
                clearInterval(spawnIntervalId);
            }
            isHolding = false;
        }
        
        function updateSquirrels(deltaTime) {
            const gameRect = gameArea.getBoundingClientRect();
            const width = gameRect.width;
            const height = gameRect.height;
            
            const speedFactor = deltaTime / 16.67; 
            const BUFFER_SIZE = SQUIRREL_SIZE; 
            
            for (let i = squirrels.length - 1; i >= 0; i--) {
                const s = squirrels[i];
                
                s.x += s.vx * speedFactor;
                s.y += s.vy * speedFactor;

                // --- –õ–û–ì–ò–ö–ê: –û—Ç—Å–∫–æ–∫ —Å –∑–∞—Ö–æ–¥–æ–º –∑–∞ –∫–∞–¥—Ä ---
                
                // –õ–µ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
                if (s.x < -BUFFER_SIZE) {
                    s.vx *= -1;
                    s.x = -BUFFER_SIZE; 
                }
                // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞
                else if (s.x > width + BUFFER_SIZE - SQUIRREL_SIZE) {
                    s.vx *= -1;
                    s.x = width + BUFFER_SIZE - SQUIRREL_SIZE; 
                }
                
                // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞
                if (s.y < -BUFFER_SIZE) {
                    s.vy *= -1;
                    s.y = -BUFFER_SIZE;
                }
                // –ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞
                else if (s.y > height + BUFFER_SIZE - SQUIRREL_SIZE) {
                    s.vy *= -1;
                    s.y = height + BUFFER_SIZE - SQUIRREL_SIZE;
                }
                
                s.element.style.left = `${s.x}px`;
                s.element.style.top = `${s.y}px`;
            }
        }

        function gameLoop(currentTime) {
            let delta = currentTime - lastTime;
            lastTime = currentTime;
            
            let rawFps = Math.round(1000 / delta); 
            if (rawFps < 0 || isNaN(rawFps) || rawFps === Infinity) {
                rawFps = 0;
            }
            if (rawFps > 120) rawFps = 120; 

            let cappedFps = Math.min(rawFps, MAX_FPS_CAP);

            // 1. –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ FPS (EMA)
            smoothedFps = (cappedFps * FPS_SMOOTHING_FACTOR) + (smoothedFps * (1 - FPS_SMOOTHING_FACTOR));
            let currentFps = Math.round(smoothedFps);
            
            // 2. –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ª–∞–≥
            if (rawFps < LAG_THRESHOLD_FPS) {
                currentFps = rawFps;
            }

            // –ò–ó–ú–ï–ù–ï–ù–ò–ï 5: –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê GAME OVER
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –¢–ï–ö–£–©–ò–ô (—Å–≥–ª–∞–∂–µ–Ω–Ω—ã–π –∏–ª–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π) FPS –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞.
            if (currentFps <= LAG_THRESHOLD_FPS) {
                fpsValue.textContent = currentFps;
                gameOver();
                return; 
            }

            // 3. –ó–∞–º–æ—Ä–æ–∑–∫–∞ FPS: –æ–±–Ω–æ–≤–ª—è–µ–º minAchievedFps, –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –Ω–∏–∂–µ.
            if (currentFps < minAchievedFps) {
                minAchievedFps = currentFps;
            }

            // 4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π FPS (—Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–∞)
            fpsValue.textContent = minAchievedFps; 
            updateSquirrels(delta); 

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function setupListeners() {
            gameArea.addEventListener('mousedown', startSpawning);
            gameArea.addEventListener('touchstart', startSpawning, { passive: false });

            document.addEventListener('mouseup', stopSpawning);
            document.addEventListener('touchend', stopSpawning);
            document.addEventListener('touchcancel', stopSpawning);
        }

        function removeListeners() {
            gameArea.removeEventListener('mousedown', startSpawning);
            gameArea.removeEventListener('touchstart', startSpawning, { passive: false });
            document.removeEventListener('mouseup', stopSpawning);
            document.removeEventListener('touchend', stopSpawning);
            document.removeEventListener('touchcancel', stopSpawning);
        }

        function gameOver() {
            cancelAnimationFrame(animationFrameId);
            stopSpawning(); 
            removeListeners();
            
            const finalScoreValue = score;
            finalScore.textContent = finalScoreValue;
            finalFpsDisplay.textContent = `–ú–∏–Ω. FPS: ${minAchievedFps}`; 
            modalOverlay.style.display = 'flex';
            
            saveProgress(finalScoreValue);
        }

        window.shareResult = function() {
            const finalScoreValue = document.getElementById('final-score').textContent;
            const finalFpsValue = minAchievedFps;
            // –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: –ë–ï–õ–û–ö –≤–º–µ—Å—Ç–æ –û–ß–ö–û–í
            const message = `–ú–æ—ë —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–¥–µ—Ä–∂–∞–ª–æ ${finalScoreValue} –±–µ–ª–æ–∫, –¥–æ—Å—Ç–∏–≥–Ω—É–≤ ${finalFpsValue} FPS! üêøÔ∏è –ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–π FPS –≤ "–ë–µ–ª–∫–∞-–¢–µ—Å—Ç–µ—Ä–µ"!`;
            
            if (isTelegram) {
                tg.sendData(`score:${finalScoreValue}|fps:${finalFpsValue}`);
                tg.close();
            } else {
                alert(`–†–ï–ó–£–õ–¨–¢–ê–¢: ${message}`);
            }
        }


        window.resetGame = function() {
            modalOverlay.style.display = 'none';

            score = 0;
            scoreValue.textContent = '0';
            
            document.querySelectorAll('.squirrel').forEach(s => s.remove());
            squirrels = []; 
            
            smoothedFps = 60; 
            minAchievedFps = MAX_FPS_CAP; 

            clickTip.style.display = 'block';

            setupListeners();
            lastTime = performance.now(); 
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        setupListeners();
        lastTime = performance.now(); 
        animationFrameId = requestAnimationFrame(gameLoop);
        modalOverlay.style.display = 'none';

    </script>
</body>
</html>
